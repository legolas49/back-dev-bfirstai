apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: backoffice-dev-image-gitops
  namespace: backoffice-dev
  annotations:
    description: 'GitOps automatique pour surveillance GHCR et mise √† jour automatique'
spec:
  components:
    - name: image-gitops
      type: kustomize
      properties:
        repoType: git
        # Repository GitHub du projet
        url: https://github.com/legolas49/back-dev-bfirstai
        # Secret pour √©criture dans le repository (√† cr√©er)
        secretRef: github-write-secret
        pullInterval: 2m
        git:
          # Branche principale
          branch: main
        # Chemin vers les configurations KubeVela
        path: ./kubevela
        imageRepository:
          # Image GHCR √† surveiller
          image: ghcr.io/legolas49/back-dev-bfirstai
          # Pattern pour filtrer les tags (SHA des commits)
          filterTags:
            # Filtre pour tags main-<sha>-<timestamp> cr√©√©s par GitHub Actions
            pattern: '^main-[a-f0-9]{7}-(?P<ts>[0-9]+)$'
            extract: '$ts'
          # Politique pour choisir la derni√®re image
          policy:
            numerical:
              order: desc # Plus r√©cent en premier
          # Message de commit personnalis√©
          commitMessage: 'ü§ñ Auto-update image: {{range .Updated.Images}}{{println .}}{{end}}'
